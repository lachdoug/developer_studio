<% @app.blueprint.schedules.each_with_id do |schedule, schedule_id| %>
  <%= custom_form_for schedule,
        namespace: "schedule[#{schedule_id}]",
        url: app_blueprint_schedules_path(app_id: @app.name,
          id: schedule_id) do |f| %>
    <legend>Schedule <%= schedule_id + 1 %></legend>
    <%= f.input :label, required: true %>
    <div class="form-section-heading">
      Timespec
    </div>
    <div class="clearfix schedule_timespec_cols">
      <div class="col-sm-2 col-sm-offset-2">
        <%= f.input :timespec_minute, label: 'Minute', pattern: "[*\/0-9]", wrapper: :vertical_form,
            input_html: { pattern_validation_error_message: "* / 0-9" } %>
      </div>
      <div class="col-sm-2">
        <%= f.input :timespec_hour, label: 'Hour', pattern: "[*\/0-9]", wrapper: :vertical_form,
            input_html: { pattern_validation_error_message: "* / 0-9" } %>
      </div>
      <div class="col-sm-2">
        <%= f.input :timespec_day_of_month, label: 'Day of month', pattern: "[*\/0-9]", wrapper: :vertical_form,
            input_html: { pattern_validation_error_message: "* / 0-9" } %>
      </div>
      <div class="col-sm-2">
        <%= f.input :timespec_month, label: 'Month', pattern: "[*\/0-9]", wrapper: :vertical_form,
            input_html: { pattern_validation_error_message: "* / 0-9" } %>
      </div>
      <div class="col-sm-2">
        <%= f.input :timespec_day_of_week, label: 'Day of week', pattern: "[*\/0-9]", wrapper: :vertical_form,
            input_html: { pattern_validation_error_message: "* / 0-9" } %>
      </div>
    </div>
    <div class="form-section-heading">
      Instruction
    </div>
    <% if f.object.instruction != 'action' %>
      <%= f.input :instruction, label: '', as: :select, required: true, collection: @app.blueprint.schedules.instruction_collection %>
    <% else %>
      <%= f.input :instruction, label: '', disabled: true, input_html: { value: f.object.instruction.humanize } %>
      <%= f.input :instruction, as: :hidden %>
      <% if f.object.actionator_name.blank? %>
        <%= f.input :actionator_name, label: 'Actionator', required: true, collection: @app.blueprint.schedules.actionator_names_collection %>
      <% else %>
        <% if f.object.blueprint_actionator.present? %>
          <%= f.input :actionator_name, label: 'Actionator', disabled: true %>
          <%= f.input :actionator_name, as: :hidden %>
          <% if f.object.blueprint_actionator_variables_mismatch %>
            <div class='col-sm-12 alert alert-danger error app_blueprint_section_custom_error'>
              The parameters specified in this schedule do not match those for the actionator definition.<br>
              Reload parameters from actionator definitions to bring them into sync.
            </div>
          <% end %>
          <% if f.object.blueprint_actionator_has_variables || f.object.variables.any? %>
            <%= f.simple_fields_for :variables do |ff| %>
              <div>
                <div class="form-section-heading">
                  <%= ff.object.send :name %>
                </div>
                <% if ff.object.variable_definition.present? %>
                  <%= ( content_tag :label, ff.object.send(:label), class: 'col-sm-9 col-sm-offset-3' ) %>
                  <%= ( content_tag :p, ff.object.send(:comment), class: 'col-sm-9 col-sm-offset-3' ) if ff.object.send(:comment).present? %>
                  <%= ff.input :name, as: :hidden %>
                  <%= ff.input :value,
                          hint: ( ff.object.send(:hint) if ff.object.send(:hint).present? ),
                          as: ff.object.send(:type),
                          collection: ff.object.send(:collection),
                          placeholder: ff.object.send(:placeholder),
                          pattern: ff.object.send(:pattern),
                          input_html: { pattern_validation_error_message: ff.object.send(:validation_message) },
                          # input_html: { 'data-validation': "custom", 'data-validation-regexp': '^([a-z]+)$' , 'data-validation-error-msg': "Invalid Regex" },
                          required: ff.object.send(:required),
                          title: ff.object.send(:title),
                          wrapper: ( :horizontal_boolean if ff.object.send(:type).to_sym == :boolean ),
                          wrapper_html: { class: 'variable_value_input_wrapper' } %>
                  <%= ff.input :resolve_string,
                          label: :Resolve,
                          placeholder: "_Engines_System(), _Engines_Builder() or _Engines_Environment()",
                          pattern: '^.*(_Engines_System|_Engines_Builder|_Engines_Environment)\(.*\).*',
                          input_html: { pattern_validation_error_message: "Must have format _Engines_System(), _Engines_Builder() or _Engines_Environment()" },
                          wrapper_html: { class: 'variable_resolve_string_input_wrapper' } %>
                  <%= ff.input :resolve,
                          input_html: { class: 'variable_resolve_checkbox_input' },
                          as: :boolean,
                          wrapper: :horizontal_boolean %>
                <% else %>
                  <span class='error app_blueprint_section_custom_error'>
                    <%= ff.input :name, as: :hidden %>
                    <%= ff.input :value, disabled: true %>
                    <div class="col-sm-12 alert alert-danger">
                      The actionator does not contain a variable for <%= ff.object.send(:name) %>.
                    </div>
                  </span>
                <% end %>
              </div>
            <% end %>
            <br>
            <div class='clearfix'>
              <%= link_to icon_text('fa-refresh', 'Reload parameters from actionator definition'),
              new_app_blueprint_schedules_variables_builder_path(app_id: @app.name,
                                                  id: schedule_id),
                remote: true, class: 'btn btn-default pull-right' %>
            </div>
            <hr>
          <% else %>
          <div class="col-sm-12 alert alert-info">
            No parameters to configure.
          </div>
          <% end %>
        <% else %>
          <div class='error app_blueprint_section_custom_error'>
            <%= f.input :actionator_name, label: 'Actionator', disabled: true %>
            <%= f.input :actionator_name, as: :hidden %>
            <div class="col-sm-12 alert alert-danger">
              An actionator for <%= "#{f.object.actionator_name}" %> is not available in the blueprint.<br>
              Please add an actionator by this name, or delete the schedule.
            </div>
          </div>
        <% end %>
      <% end %>







    <% end %>











    <div class='clearfix'>
      <%= link_to icon_text('fa-trash-o',
        "Delete schedule #{schedule_id + 1}"),
        app_blueprint_schedules_schedule_path(app_id: @app.name,
                                            id: schedule_id),
        method: :delete, remote: true, class: 'btn btn-default pull-right',
        data: { confirm:
          "Are you sure that you want to delete this schedule?"} %>
    </div>
    <hr>
  <% end %>
<% end %>
<div class='clearfix'>
  <%= link_to icon_text('fa-plus', 'New schedule'),
      new_app_blueprint_schedules_path(app_id: @app.name),
      remote: true, class: 'btn btn-default pull-right' %>
</div>



<% if false %>


<% end %>
