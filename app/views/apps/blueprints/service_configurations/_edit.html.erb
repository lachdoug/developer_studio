<% @app.blueprint.service_configurations.each_with_id do |service_configuration, service_configuration_id| %>
  <%= custom_form_for service_configuration,
        namespace: "service_configuration[#{service_configuration_id}]",
        url: app_blueprint_service_configurations_path(app_id: @app.name,
          id: service_configuration_id) do |f| %>
    <legend>Service configuration <%= service_configuration_id + 1 %></legend>
    <% if f.object.namespace.blank? %>
      <%= f.input :namespace, as: :select, required: true,
          collection: Settings::ServiceDefinitionNamespace.namespaces_collection %>
    <% elsif f.object.type_path.blank? %>
      <%= f.input :namespace, disabled: true %>
      <%= f.input :namespace, as: :hidden %>
      <%= f.input :type_path, as: :select, required: true,
          collection: Settings::ServiceDefinitionNamespace.
                        type_paths_collection_for(f.object.namespace) %>
    <% else %>
      <% if f.object.service_definition.present? %>
        <%= f.input :namespace, disabled: true %>
        <%= f.input :namespace, as: :hidden %>
        <%= f.input :type_path, disabled: true %>
        <%= f.input :type_path, as: :hidden %>
        <% if f.object.service_definition_consumer_params_mismatch %>
          <div class='col-sm-12 alert alert-danger error app_blueprint_section_custom_error'>
            The parameters specified in this configuration do not match those in the service definition.<br>
            Reload parameters from service definition to bring them into sync.
          </div>
        <% end %>
        <% if f.object.service_definition_has_consumer_params || f.object.variables.any? %>
          <%= f.simple_fields_for :variables do |ff| %>
            <div>
              <div class="form-section-heading">
                <%= ff.object.send :name %>
              </div>
              <% if ff.object.variable_definition.present? %>
                <%= ( content_tag :label, ff.object.send(:label), class: 'col-sm-9 col-sm-offset-3' ) %>
                <%= ( content_tag :p, ff.object.send(:comment), class: 'col-sm-9 col-sm-offset-3' ) if ff.object.send(:comment).present? %>
                <%= ff.input :name, as: :hidden %>
                <%= ff.input :value,
                        hint: ( ff.object.send(:hint) if ff.object.send(:hint).present? ),
                        as: ff.object.send(:type),
                        collection: ff.object.send(:collection),
                        placeholder: ff.object.send(:placeholder),
                        title: ff.object.send(:title),
                        wrapper: ( :horizontal_boolean if ff.object.send(:type).to_sym == :boolean ),
                        wrapper_html: { class: 'variable_value_input_wrapper' }  %>
                <%= ff.input :resolve_string,
                        label: :Resolve,
                        placeholder: "_Engines_System(), _Engines_Builder() or _Engines_Environment()",
                        pattern: '^.*(_Engines_System|_Engines_Builder|_Engines_Environment)\(.*\).*',
                        wrapper_html: { class: 'variable_resolve_string_input_wrapper' } %>
                <%= ff.input :resolve,
                        input_html: { class: 'variable_resolve_checkbox_input' },
                        as: :boolean,
                        wrapper: :horizontal_boolean %>
              <% else %>
                <span class='error app_blueprint_section_custom_error'>
                  <%= ff.input :name, as: :hidden %>
                  <%= ff.input :value, disabled: true %>
                  <div class="col-sm-12 alert alert-danger">
                    The service definition does not contain a consumer parameter for <%= ff.object.send(:name) %>.
                  </div>
                </span>
              <% end %>
            </div>
          <% end %>
          <br>
          <div class='clearfix'>
            <%= link_to icon_text('fa-refresh', 'Reload parameters from service definition'),
            new_app_blueprint_service_configurations_variables_builder_path(app_id: @app.name,
                                                id: service_configuration_id),
              remote: true, class: 'btn btn-default pull-right' %>
          </div>
          <hr>
        <% else %>
        <div class="col-sm-12 alert alert-info">
          No consumer parameters to configure.
        </div>
        <% end %>
      <% else %>
        <div class='error app_blueprint_section_custom_error'>
          <%= f.input :namespace, disabled: true %>
          <%= f.input :namespace, as: :hidden %>
          <%= f.input :type_path, disabled: true %>
          <%= f.input :type_path, as: :hidden %>
          <div class="col-sm-12 alert alert-danger">
            A service definition for <%= "#{f.object.namespace}/#{f.object.type_path}" %> is not available.<br>
            Please add the service definition in <%= link_to icon_text('fa-cog', :Settings), settings_path %>, or delete this service configuration.
          </div>
        </div>
      <% end %>
    <% end %>
    <div class='clearfix'>
      <%= link_to icon_text('fa-trash-o',
        "Delete service configuration #{service_configuration_id + 1}"),
        app_blueprint_service_configurations_service_configuration_path(app_id: @app.name,
                                            id: service_configuration_id),
        method: :delete, remote: true, class: 'btn btn-default pull-right',
        data: { confirm:
          "Are you sure that you want to delete this service configuration?"} %>
    </div>
    <hr>
  <% end %>
<% end %>
<div class='clearfix'>
  <%= link_to icon_text('fa-plus', 'New service configuration'),
      new_app_blueprint_service_configurations_path(app_id: @app.name),
      remote: true, class: 'btn btn-default pull-right' %>
</div>
